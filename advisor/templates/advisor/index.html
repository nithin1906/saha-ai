<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SAHA-AI: Your AI Stock & Mutual Fund Assistant</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js (kept in case charts are used elsewhere) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        html.dark { color-scheme: dark; }
        body { font-family: 'Inter', sans-serif; }
        #chat-window { scroll-behavior: smooth; }
        .chat-bubble { opacity: 0; transform: translateY(18px); animation: popIn 0.35s ease-out forwards; box-shadow: 0 4px 12px -4px rgba(0,0,0,0.1); }
        @keyframes popIn { to { opacity: 1; transform: translateY(0); } }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .mobile-sidebar {
                position: fixed;
                top: 0;
                left: -100%;
                width: 280px;
                height: 100vh;
                z-index: 50;
                transition: left 0.3s ease-in-out;
            }
            .mobile-sidebar.open {
                left: 0;
            }
            .mobile-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 40;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease-in-out;
            }
            .mobile-overlay.open {
                opacity: 1;
                visibility: visible;
            }
            .mobile-main {
                width: 100%;
                margin-left: 0;
            }
            .mobile-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 1rem;
                background: white;
                border-bottom: 1px solid #e5e7eb;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                position: sticky;
                top: 0;
                z-index: 30;
            }
            .mobile-menu-btn {
                padding: 0.5rem;
                border-radius: 0.75rem;
                background: #f3f4f6;
                border: none;
                cursor: pointer;
                transition: all 0.2s ease;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            .mobile-menu-btn:hover {
                background: #e5e7eb;
                transform: translateY(-1px);
                box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            }
            .mobile-logo {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            .mobile-logo h1 {
                font-size: 1.25rem;
                font-weight: 700;
                color: #1f2937;
            }
            .mobile-logo p {
                font-size: 0.75rem;
                color: #6b7280;
                margin: 0;
            }
            .market-cards-mobile {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.75rem;
                max-height: 200px;
                overflow-y: auto;
            }
            .market-card-mobile {
                width: 100%;
                padding: 0.75rem;
                border-radius: 0.75rem;
                background: white;
                border: 1px solid #e5e7eb;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                transition: all 0.2s ease;
            }
            .market-card-mobile:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }
            .chat-window-mobile {
                padding: 1rem;
                height: calc(100vh - 280px);
                overflow-y: auto;
                scroll-behavior: smooth;
            }
            .chat-window-mobile::-webkit-scrollbar {
                width: 4px;
            }
            .chat-window-mobile::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 2px;
            }
            .chat-window-mobile::-webkit-scrollbar-thumb {
                background: #c1c1c1;
                border-radius: 2px;
            }
            .chat-window-mobile::-webkit-scrollbar-thumb:hover {
                background: #a8a8a8;
            }
            .input-area-mobile {
                padding: 0.75rem;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-top: 1px solid #e5e7eb;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
                backdrop-filter: blur(10px);
                background: rgba(255, 255, 255, 0.95);
            }
            .suggestions-mobile {
                display: flex;
                flex-wrap: wrap;
                gap: 0.375rem;
                margin-top: 0.75rem;
                justify-content: center;
                max-width: 100%;
                overflow-x: auto;
                padding: 0 0.25rem;
            }
            .suggestion-chip-mobile {
                font-size: 0.8rem;
                padding: 0.5rem 0.75rem;
                border-radius: 1.5rem;
                background: #f3f4f6;
                color: #374151;
                border: none;
                cursor: pointer;
                transition: all 0.2s;
                white-space: nowrap;
                flex-shrink: 0;
                min-width: fit-content;
            }
            .suggestion-chip-mobile:hover {
                background: #e5e7eb;
                transform: translateY(-1px);
            }
            .input-field-mobile {
                font-size: 0.9rem;
                padding: 0.75rem 3rem 0.75rem 1rem;
                border-radius: 1.5rem;
                border: 1px solid #d1d5db;
                background: white;
                width: 100%;
                box-sizing: border-box;
            }
            .input-field-mobile:focus {
                outline: none;
                border-color: #3b82f6;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }
        }

        /* Bot bubble */
        .chat-bubble-bot { background-color: #ffffff; color: #1f2937; border: 1px solid #e5e7eb; }
        html.dark .chat-bubble-bot { background-color: #111827; color: #f3f4f6; border-color: #374151; }

        /* User bubble */
        .chat-bubble-user { background-image: linear-gradient(90deg,#3b82f6,#1d4ed8); color: #fff; }

        /* Light mode clean design */
        html:not(.dark) body { background-color: #f9fafb; color: #1f2937; }
        html:not(.dark) aside { background-color: #ffffff; border-right: 1px solid #e5e7eb; }
        html:not(.dark) main { background-color: #fafafa; }

        /* Chat area */
        html:not(.dark) #chat-window { background-color: #ffffff; }
        html:not(.dark) .chat-bubble-bot { background-color: #f3f4f6; color: #111827; border: 1px solid #e5e7eb; }
        html:not(.dark) .chat-bubble-user { background-image: linear-gradient(90deg,#2563eb,#1d4ed8); color: #fff; }

        /* Disclaimer bubble */
        html:not(.dark) .chat-bubble-bot.bg-yellow-100 {
          background-color: #fef9c3 !important;
          border-color: #fde68a !important;
          color: #92400e !important;
        }

        /* Portfolio health card */
        html:not(.dark) #portfolio-health-section {
          background-color: #f9fafb;
          border: 1px solid #e5e7eb;
        }

        /* Market snapshot */
        html:not(.dark) #market-snapshot { background-color: #ffffff; }
        html:not(.dark) #market-cards div { background-color: #f3f4f6; border: 1px solid #e5e7eb; }

        /* Input area */
        html:not(.dark) .p-4 { background-color: #f9fafb; }
        html:not(.dark) input { background-color: #ffffff; border-color: #d1d5db; color: #111827; }

        /* Footer */
        html:not(.dark) footer, 
        html:not(.dark) .text-center p { color: #6b7280; }

        /* --- Sidebar fixes --- */
        html:not(.dark) aside {
          background-color: #ffffff;
          border-right: 1px solid #e5e7eb;
        }
        html:not(.dark) aside a {
          color: #374151;
        }
        html:not(.dark) aside a:hover {
          background-color: #f3f4f6;
        }
        html:not(.dark) aside a span {
          color: #111827;
        }
        html:not(.dark) aside a svg {
          color: #6b7280;
        }
        /* Active link highlight */
        html:not(.dark) aside a.bg-gray-900,
        html:not(.dark) aside a[aria-current="page"] {
          background-color: #e0f2fe !important;
          color: #0369a1 !important;
        }
        html:not(.dark) aside a.bg-gray-900 span {
          color: #0369a1 !important;
        }
        html:not(.dark) aside a.bg-gray-900 svg {
          color: #0284c7 !important;
        }

        /* --- Market snapshot fixes --- */
        html:not(.dark) #market-snapshot {
          background-color: #ffffff;
          border-bottom: 1px solid #e5e7eb;
        }
        html:not(.dark) #market-cards div {
          background-color: #ffffff !important;
          border: 1px solid #e5e7eb !important;
          box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }
        html:not(.dark) #market-cards span {
          color: #111827 !important;
        }
        /* Market data numbers visibility - make text red */
        html:not(.dark) #market-cards div div {
          color: #dc2626 !important;
        }
        /* Preserve green/red colors for market changes */
        html:not(.dark) #market-cards .text-emerald-600 {
          color: #059669 !important;
        }
        html:not(.dark) #market-cards .text-red-600 {
          color: #dc2626 !important;
        }
        /* Black container outlines */
        html:not(.dark) #market-cards .bg-emerald-50 {
          border-color: #000000 !important;
          border-width: 2px !important;
        }
        html:not(.dark) #market-cards .bg-red-50 {
          border-color: #000000 !important;
          border-width: 2px !important;
        }

        /* --- Username and profile fixes --- */
        html:not(.dark) aside .text-gray-900 { color: #111827 !important; }
        html:not(.dark) aside .text-gray-100 { color: #111827 !important; }
        html:not(.dark) aside .text-gray-600 { color: #374151 !important; }
        html:not(.dark) aside .text-gray-400 { color: #6b7280 !important; }
        
        /* Fix profile button hover effect */
        html:not(.dark) #profile-button:hover {
          background-color: #f3f4f6 !important;
        }
        html:not(.dark) #profile-button:hover .text-gray-900 {
          color: #111827 !important;
        }
        html:not(.dark) #profile-button:hover .text-gray-100 {
          color: #111827 !important;
        }
        html:not(.dark) #profile-button:hover .text-gray-600 {
          color: #374151 !important;
        }
        html:not(.dark) #profile-button:hover .text-gray-400 {
          color: #6b7280 !important;
        }
        
        /* --- Logout dropdown fixes --- */
        html:not(.dark) #profile-dropdown {
          background-color: #ffffff !important;
          border: 1px solid #e5e7eb !important;
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
        }
        html:not(.dark) #profile-dropdown button {
          color: #374151 !important;
          background-color: transparent !important;
        }
        html:not(.dark) #profile-dropdown button:hover {
          background-color: #f3f4f6 !important;
          color: #111827 !important;
        }

        /* --- Portfolio health score color coding --- */
        html:not(.dark) #portfolio-health-section .text-green-500 {
          color: #059669 !important;
        }
        html:not(.dark) #portfolio-health-section .text-yellow-500 {
          color: #d97706 !important;
        }
        html:not(.dark) #portfolio-health-section .text-red-500 {
          color: #dc2626 !important;
        }

        /* --- Footer fixes --- */
        html:not(.dark) .text-center.p-2 {
          background-color: #f9fafb !important;
          border-top: 1px solid #e5e7eb !important;
        }
        html:not(.dark) .text-center.p-2 p {
          color: #6b7280 !important;
        }

        /* Additional refinements */
        html:not(.dark) .sticky { background-color: rgba(255,255,255,0.9); border-bottom: 1px solid #e5e7eb; backdrop-filter: blur(8px); }
        html:not(.dark) .market-skeleton-card { background: rgba(0,0,0,0.05); border-color: rgba(0,0,0,0.08); }
        html:not(.dark) .suggestion-chip { background:#f1f5f9; color:#334155; }
        html:not(.dark) .choice-btn { background:#f9fafb; color:#1f2937; border:1px solid #e5e7eb; }
        
        /* Fix suggestion chips spacing */
        .suggestion-chip {
          margin: 0.4rem !important;
        }

        /* Hover states */
        .action-btn, .suggestion-chip, .holding-item-clickable { cursor: pointer; transition: all 0.15s ease-in-out; }
        .action-btn:hover, .holding-item-clickable:hover { transform: translateY(-2px); box-shadow: 0 6px 14px rgba(0,0,0,0.08); }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 6px; }
        html.dark ::-webkit-scrollbar-thumb { background: #4b5563; }

        /* Typing dots */
        .typing { display:inline-flex; align-items:center; }
        .typing .dot { width:6px; height:6px; border-radius:999px; background:#9ca3af; margin:0 2px; opacity:.4; animation: blink 1.4s infinite; }
        .typing .dot:nth-child(2) { animation-delay:.2s }
        .typing .dot:nth-child(3) { animation-delay:.4s }
        @keyframes blink { 0%, 80%, 100% { opacity:.2 } 40% { opacity:1 } }

        /* Fade-in for cards */
        .fade-in { opacity: 0; transform: translateY(4px); animation: fin 350ms ease-out forwards; }
        @keyframes fin { to { opacity: 1; transform: translateY(0); } }

        /* Market skeleton loading tiles */
        .market-skeleton-card {
            min-width: 180px;
            height: 60px;
            background: rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(2px);
            border-radius: 0.5rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 0.75rem;
            margin: 0.25rem;
            animation: skeleton-pulse 1.5s ease-in-out infinite;
        }
        html.dark .market-skeleton-card {
            background: rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 255, 255, 0.1);
        }
        @keyframes skeleton-pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        .market-skeleton-content {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .market-skeleton-line {
            height: 12px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            animation: skeleton-pulse 1.5s ease-in-out infinite;
        }
        html.dark .market-skeleton-line {
            background: rgba(255, 255, 255, 0.1);
        }
        .market-skeleton-line.short {
            width: 60%;
        }
        .market-skeleton-line.long {
            width: 80%;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

<div class="h-screen flex">
    <!-- Mobile Overlay -->
    <div id="mobile-overlay" class="mobile-overlay"></div>
    
    <!-- Sidebar -->
    <aside id="sidebar" class="w-1/3 max-w-sm h-screen flex flex-col bg-white dark:bg-gray-900 border-r border-gray-200 dark:border-gray-800 p-4 mobile-sidebar">
        <div class="flex items-center space-x-3 mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-400" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" /><path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" /></svg>
            <div>
                <h1 class="text-xl font-bold text-gray-900 dark:text-gray-100">SAHA-AI</h1>
                <p class="text-sm text-gray-600 dark:text-gray-400">Your Finance Analyst</p>
            </div>
        </div>

        <!-- Profile -->
        <div class="relative mb-6">
            <button id="profile-button" class="w-full flex items-center justify-between p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                        {% if user.first_name %}{{ user.first_name|first|upper }}{% else %}{{ user.username|first|upper }}{% endif %}
                    </div>
                    <div class="text-left">
                        <p class="font-semibold text-sm text-gray-900 dark:text-gray-100">Hi, {% if user.first_name %}{{ user.first_name }}{% else %}{{ user.username }}{% endif %}</p>
                        <p class="text-xs text-gray-600 dark:text-gray-400">@{{ user.username }}</p>
                    </div>
                </div>
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="profile-dropdown" class="hidden absolute left-0 mt-2 w-48 bg-white dark:bg-gray-700 rounded-md shadow-lg py-1 z-20 opacity-0 transform scale-95">
                <form action="{% url 'logout' %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600">Logout</button>
                </form>
            </div>
        </div>

        <nav class="space-y-2">
            <a href="{% url 'portfolio' %}" class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <svg class="w-6 h-6 text-gray-600 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7c0-1.1.9-2 2-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <span class="font-medium text-gray-900 dark:text-gray-100">My Portfolio</span>
            </a>
            <a href="{% url 'profile' %}" class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <svg class="w-6 h-6 text-gray-600 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                <span class="font-medium text-gray-900 dark:text-gray-100">My Profile</span>
            </a>
            {% if user.is_superuser %}
            <a href="{% url 'admin_dashboard' %}" class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <svg class="w-6 h-6 text-gray-600 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                <span class="font-medium text-gray-900 dark:text-gray-100">Admin Dashboard</span>
            </a>
            {% endif %}
            <a href="{% url 'about' %}" class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <svg class="w-6 h-6 text-gray-600 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span class="font-medium text-gray-900 dark:text-gray-100">About Us</span>
            </a>

        </nav>

        <div id="portfolio-health-section" class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg mt-6">
            <h2 class="font-bold text-lg mb-2 text-gray-900 dark:text-gray-100">Portfolio Health</h2>
            <div id="health-score-placeholder" class="text-center text-gray-600 dark:text-gray-400">Loading score...</div>
            <div id="health-score-display" class="hidden"></div>
        </div>
        
        <!-- Mobile Portfolio Health Section -->
        <div id="portfolio-health-section-mobile" class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg mt-6 md:hidden">
            <h2 class="font-bold text-lg mb-2 text-gray-900 dark:text-gray-100">Portfolio Health</h2>
            <div id="health-score-placeholder-mobile" class="text-center text-gray-600 dark:text-gray-400">Loading score...</div>
            <div id="health-score-display-mobile" class="hidden"></div>
        </div>
    </aside>

    <!-- Chat main -->
    <main class="flex-1 flex flex-col bg-white dark:bg-gray-800 mobile-main">
        <!-- Mobile Header -->
        <div class="mobile-header md:hidden">
            <button id="mobile-menu-btn" class="mobile-menu-btn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
            <div class="mobile-logo">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" />
                    <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" />
                </svg>
                <div>
                    <h1>SAHA-AI</h1>
                    <p>Your Finance Analyst</p>
                </div>
            </div>
            <button id="theme-toggle-mobile" class="mobile-menu-btn">
                <svg id="theme-toggle-dark-icon-mobile" class="hidden w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                </svg>
                <svg id="theme-toggle-light-icon-mobile" class="hidden w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
            </button>
        </div>

        <!-- Top bar with theme toggle -->
        <div class="sticky top-0 z-10 bg-white/90 dark:bg-gray-900/90 backdrop-blur border-b border-gray-200 dark:border-gray-700 hidden md:block">
            <div class="max-w-3xl mx-auto px-3 py-2 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <span class="text-[11px] tracking-wide uppercase text-gray-600 dark:text-gray-400">Market</span>
                    <span id="market-status" class="text-[11px] font-semibold text-gray-700 dark:text-gray-300"></span>
                </div>
                <button id="theme-toggle" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Toggle theme">
                    <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden w-5 h-5 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                </button>
            </div>
        </div>
        
        <!-- Market snapshot bar -->
        <div id="market-snapshot" class="bg-white/90 dark:bg-gray-900/90 backdrop-blur border-b border-gray-200 dark:border-gray-700">
            <div class="max-w-3xl mx-auto px-3 py-2 hidden md:block">
                <div id="market-cards" class="flex items-stretch space-x-2 overflow-x-auto hide-scrollbar">
                    <!-- Skeleton loading cards -->
                    <div class="market-skeleton-card">
                        <div class="market-skeleton-content">
                            <div class="market-skeleton-line short"></div>
                            <div class="market-skeleton-line long"></div>
                        </div>
                    </div>
                    <div class="market-skeleton-card">
                        <div class="market-skeleton-content">
                            <div class="market-skeleton-line short"></div>
                            <div class="market-skeleton-line long"></div>
                        </div>
                    </div>
                    <div class="market-skeleton-card">
                        <div class="market-skeleton-content">
                            <div class="market-skeleton-line short"></div>
                            <div class="market-skeleton-line long"></div>
                        </div>
                    </div>
                    <div class="market-skeleton-card">
                        <div class="market-skeleton-content">
                            <div class="market-skeleton-line short"></div>
                            <div class="market-skeleton-line long"></div>
                        </div>
                    </div>
                    <div class="market-skeleton-card">
                        <div class="market-skeleton-content">
                            <div class="market-skeleton-line short"></div>
                            <div class="market-skeleton-line long"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Mobile Market Cards -->
            <div id="market-cards-mobile" class="market-cards-mobile md:hidden">
                <!-- Mobile market cards will be populated here -->
            </div>
        </div>
        <div id="chat-window" class="flex-1 p-6 overflow-y-auto w-full max-w-3xl mx-auto bg-white dark:bg-gray-800 chat-window-mobile">
            <!-- Beta Testing Welcome Message -->
            <div id="beta-welcome" class="w-full max-w-2xl mx-auto mb-6" style="display: none;">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg p-6 shadow-lg border border-blue-200 dark:border-blue-700">
                    <div class="text-center">
                        <div class="text-4xl mb-3">🚀</div>
                        <h3 class="text-xl font-bold text-blue-800 dark:text-blue-200 mb-3">Welcome to SAHA-AI Beta Testing!</h3>
                        <p class="text-blue-700 dark:text-blue-300 mb-4">
                            You're among the first users to experience our AI-powered investment assistant. This is a testing phase, and we're excited to have you on board!
                        </p>
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg p-4 mb-4">
                            <p class="text-yellow-800 dark:text-yellow-200 text-sm font-medium">
                                ⚠️ <strong>Important:</strong> If you encounter any bugs or issues, please report them directly to our development team. Your feedback is invaluable for improving the platform.
                            </p>
                        </div>
                        <p class="text-blue-600 dark:text-blue-400 text-sm mb-4">
                            By continuing to use SAHA-AI, you consent to participating in this beta testing program and understand that this is a work-in-progress platform.
                        </p>
                        <button onclick="acceptBetaTesting()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            I Understand - Let's Start!
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Regular Welcome Message -->
            <div id="initial-greeting" class="w-full max-w-md p-3 rounded-xl mb-4 chat-bubble chat-bubble-bot">
                Hi, I am SAHA-AI, How may I help you today?
            </div>
        </div>

        <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 input-area-mobile">
            <div class="w-full max-w-3xl mx-auto">
                <div class="relative">
                    <input id="user-input" type="text" class="w-full p-3 pr-12 border border-gray-300 dark:border-gray-600 rounded-full bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 input-field-mobile" placeholder="Ask about stocks, mutual funds, or portfolio">
                    <button id="send-button" class="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-full transition duration-300">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>
                    </button>
                </div>

                <div id="quick-suggestions" class="mt-3 text-center suggestions-mobile">
                    <span class="suggestion-chip suggestion-chip-mobile" id="chip-analyze-stock">Analyze a stock</span>
                    <span class="suggestion-chip suggestion-chip-mobile" id="chip-analyze-mf">Analyze a mutual fund</span>
                    <span class="suggestion-chip suggestion-chip-mobile" id="chip-show-portfolio">Show my portfolio</span>
                </div>

                <div id="suggestions-box" class="mt-3 text-center"></div>
            </div>
        </div>

        <div class="text-center p-2 bg-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
            <p class="text-xs text-gray-500 dark:text-gray-500">© 2025 SAHA-AI Project. All Rights Reserved.</p>
        </div>
    </main>
</div>

<!-- server-passed values -->
{{ user_first_name|json_script:"user-first-name" }}
{{ csrf_token_value|json_script:"csrf-token" }}
<script>
// Lightweight live-reload: polls backend version and reloads page when it changes
(function(){
    let lastVersion = null;
    async function check(){
        try{
            const r = await fetch('/api/dev/version/');
            const d = await r.json();
            if(lastVersion === null){ lastVersion = d.version; }
            else if(d.version !== lastVersion){ location.reload(); }
        }catch(e){ /* ignore */ }
    }
    setInterval(check, 3000);
    check();
})();
</script>

<script>
// Mobile detection and under development screen
function isMobileDevice() {
    return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

function showMobileUnderDevelopment() {
    if (isMobileDevice()) {
        document.body.innerHTML = `
            <div style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                color: white;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                z-index: 9999;
            ">
                <div style="
                    text-align: center;
                    padding: 2rem;
                    max-width: 90%;
                    animation: fadeInUp 1s ease-out;
                ">
                    <!-- Animated Logo -->
                    <div style="
                        width: 120px;
                        height: 120px;
                        margin: 0 auto 2rem;
                        background: rgba(255, 255, 255, 0.1);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: pulse 2s infinite;
                        backdrop-filter: blur(10px);
                        border: 2px solid rgba(255, 255, 255, 0.2);
                    ">
                        <svg style="width: 60px; height: 60px; color: #10b981;" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" />
                            <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" />
                        </svg>
                    </div>
                    
                    <!-- App Name -->
                    <h1 style="
                        font-size: 2.5rem;
                        font-weight: 700;
                        margin-bottom: 0.5rem;
                        background: linear-gradient(45deg, #10b981, #3b82f6);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        background-clip: text;
                    ">SAHA-AI</h1>
                    
                    <p style="
                        font-size: 1.2rem;
                        margin-bottom: 2rem;
                        opacity: 0.9;
                    ">Your Finance Analyst</p>
                    
                    <!-- Under Development Message -->
                    <div style="
                        background: rgba(255, 255, 255, 0.1);
                        padding: 2rem;
                        border-radius: 1rem;
                        backdrop-filter: blur(10px);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        margin-bottom: 2rem;
                    ">
                        <div style="
                            font-size: 3rem;
                            margin-bottom: 1rem;
                            animation: bounce 2s infinite;
                        ">🚧</div>
                        
                        <h2 style="
                            font-size: 1.5rem;
                            font-weight: 600;
                            margin-bottom: 1rem;
                        ">Mobile App Coming Soon!</h2>
                        
                        <p style="
                            font-size: 1rem;
                            line-height: 1.6;
                            opacity: 0.9;
                            margin-bottom: 1.5rem;
                        ">
                            We're working hard to bring you the best mobile experience for SAHA-AI. 
                            Our mobile app will be available soon with all the features you love!
                        </p>
                        
                        <div style="
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 0.5rem;
                            font-size: 0.9rem;
                            opacity: 0.8;
                        ">
                            <span>📱</span>
                            <span>Stay tuned for updates!</span>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div style="
                        width: 100%;
                        max-width: 300px;
                        margin: 0 auto;
                    ">
                        <div style="
                            background: rgba(255, 255, 255, 0.2);
                            height: 8px;
                            border-radius: 4px;
                            overflow: hidden;
                            margin-bottom: 0.5rem;
                        ">
                            <div style="
                                background: linear-gradient(90deg, #10b981, #3b82f6);
                                height: 100%;
                                width: 75%;
                                border-radius: 4px;
                                animation: progress 3s ease-in-out infinite;
                            "></div>
                        </div>
                        <p style="
                            font-size: 0.9rem;
                            opacity: 0.8;
                            text-align: center;
                        ">Development Progress: 75%</p>
                    </div>
                    
                    <!-- Desktop Notice -->
                    <div style="
                        margin-top: 2rem;
                        padding: 1rem;
                        background: rgba(255, 255, 255, 0.05);
                        border-radius: 0.5rem;
                        border: 1px solid rgba(255, 255, 255, 0.1);
                    ">
                        <p style="
                            font-size: 0.9rem;
                            opacity: 0.8;
                        ">
                            💻 For the best experience, please use our web app on desktop
                        </p>
                    </div>
                </div>
            </div>
            
            <style>
                @keyframes fadeInUp {
                    from {
                        opacity: 0;
                        transform: translateY(30px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
                
                @keyframes pulse {
                    0%, 100% {
                        transform: scale(1);
                    }
                    50% {
                        transform: scale(1.05);
                    }
                }
                
                @keyframes bounce {
                    0%, 20%, 50%, 80%, 100% {
                        transform: translateY(0);
                    }
                    40% {
                        transform: translateY(-10px);
                    }
                    60% {
                        transform: translateY(-5px);
                    }
                }
                
                @keyframes progress {
                    0% {
                        transform: translateX(-100%);
                    }
                    50% {
                        transform: translateX(0%);
                    }
                    100% {
                        transform: translateX(100%);
                    }
                }
            </style>
        `;
        return true;
    }
    return false;
}

// Security Functions - Mandatory Logout on Browser/Tab Close
let sessionActive = true;
let sessionCheckInterval;

function initializeSessionSecurity() {
    // Set up session monitoring
    sessionCheckInterval = setInterval(checkSessionStatus, 30000); // Check every 30 seconds
    
    // Detect browser/tab close
    window.addEventListener('beforeunload', handleBrowserClose);
    window.addEventListener('unload', handleBrowserClose);
    
    // Detect tab visibility changes (tab switching)
    document.addEventListener('visibilitychange', handleVisibilityChange);
    
    // Detect page focus/blur
    window.addEventListener('blur', handlePageBlur);
    window.addEventListener('focus', handlePageFocus);
    
    // Detect idle time
    let idleTimer;
    const idleTimeout = 15 * 60 * 1000; // 15 minutes
    
    function resetIdleTimer() {
        clearTimeout(idleTimer);
        idleTimer = setTimeout(forceLogout, idleTimeout);
    }
    
    // Reset idle timer on user activity
    ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
        document.addEventListener(event, resetIdleTimer, true);
    });
    
    resetIdleTimer();
}

function handleBrowserClose(event) {
    if (sessionActive) {
        // Force logout before browser closes
        forceLogout();
    }
}

function handleVisibilityChange() {
    if (document.hidden && sessionActive) {
        // Tab became hidden - start logout timer
        setTimeout(() => {
            if (document.hidden && sessionActive) {
                forceLogout();
            }
        }, 30000); // 30 seconds after tab becomes hidden
    }
}

function handlePageBlur() {
    if (sessionActive) {
        // Page lost focus - start logout timer
        setTimeout(() => {
            if (!document.hasFocus() && sessionActive) {
                forceLogout();
            }
        }, 60000); // 1 minute after losing focus
    }
}

function handlePageFocus() {
    // Page regained focus - check session status
    checkSessionStatus();
}

function checkSessionStatus() {
    if (!sessionActive) return;
    
    // Check if session is still valid by making a lightweight request
    fetch('/api/portfolio/health/', {
        method: 'GET',
        credentials: 'include'
    })
    .then(response => {
        if (response.status === 401 || response.status === 403) {
            // Session expired
            forceLogout();
        }
    })
    .catch(error => {
        console.log('Session check failed:', error);
        // Don't logout on network errors, just log
    });
}

function forceLogout() {
    if (!sessionActive) return;
    
    sessionActive = false;
    clearInterval(sessionCheckInterval);
    
    // Clear any sensitive data
    localStorage.removeItem('saha-ai-beta-welcome');
    
    // Show logout message
    alert('🔒 Security Notice: Your session has expired for security reasons. Please log in again to continue.');
    
    // Redirect to login
    window.location.href = '/users/login/';
}

// Beta Testing Functions
function checkFirstTimeUser() {
    const hasSeenBetaWelcome = localStorage.getItem('saha-ai-beta-welcome');
    if (!hasSeenBetaWelcome) {
        // Show beta welcome message
        const betaWelcome = document.getElementById('beta-welcome');
        const initialGreeting = document.getElementById('initial-greeting');
        if (betaWelcome && initialGreeting) {
            betaWelcome.style.display = 'block';
            initialGreeting.style.display = 'none';
        }
    }
}

function acceptBetaTesting() {
    // Hide beta welcome and show regular greeting
    const betaWelcome = document.getElementById('beta-welcome');
    const initialGreeting = document.getElementById('initial-greeting');
    
    if (betaWelcome && initialGreeting) {
        betaWelcome.style.display = 'none';
        initialGreeting.style.display = 'block';
    }
    
    // Mark as seen
    localStorage.setItem('saha-ai-beta-welcome', 'true');
}

document.addEventListener('DOMContentLoaded', () => {
    // Check if mobile and show under development screen
    if (showMobileUnderDevelopment()) {
        return; // Stop execution for mobile devices
    }
    
    // Initialize security features
    initializeSessionSecurity();
    
    // Check for first-time user and show beta welcome
    checkFirstTimeUser();
    
    // DOM refs
    const chatWindow = document.getElementById('chat-window');
    const marketCards = document.getElementById('market-cards');
    const marketStatus = document.getElementById('market-status');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const suggestionsBox = document.getElementById('suggestions-box');
    const chipAnalyzeStock = document.getElementById('chip-analyze-stock');
    const chipAnalyzeMF = document.getElementById('chip-analyze-mf');
    const chipShowPortfolio = document.getElementById('chip-show-portfolio');
    const profileButton = document.getElementById('profile-button');
    const profileDropdown = document.getElementById('profile-dropdown');
    const themeToggle = document.getElementById('theme-toggle');
    const darkIcon = document.getElementById('theme-toggle-dark-icon');
    const lightIcon = document.getElementById('theme-toggle-light-icon');
    const healthScorePlaceholder = document.getElementById('health-score-placeholder');
    const healthScoreDisplay = document.getElementById('health-score-display');
    const initialGreetingEl = document.getElementById('initial-greeting');
    
    // Mobile elements
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileOverlay = document.getElementById('mobile-overlay');
    const sidebar = document.getElementById('sidebar');
    const themeToggleMobile = document.getElementById('theme-toggle-mobile');
    const darkIconMobile = document.getElementById('theme-toggle-dark-icon-mobile');
    const lightIconMobile = document.getElementById('theme-toggle-light-icon-mobile');
    const marketCardsMobile = document.getElementById('market-cards-mobile');

    // injected data
    const userFirstNameElement = document.getElementById('user-first-name');
    const csrfTokenElement = document.getElementById('csrf-token');
    const userName = userFirstNameElement ? JSON.parse(userFirstNameElement.textContent) : '';
    const csrfToken = csrfTokenElement ? JSON.parse(csrfTokenElement.textContent) : '';

    // conversation state
    let conversationState = 'AWAITING_PROMPT';
    let analysisContext = {}; // { type: 'stock'|'mf', ... }
    let isFirstInteraction = true;
    let lastRequestedFlow = null; // 'stock' | 'mf' | null

    // Mobile menu functionality
    function toggleMobileMenu() {
        sidebar.classList.toggle('open');
        mobileOverlay.classList.toggle('open');
    }

    function closeMobileMenu() {
        sidebar.classList.remove('open');
        mobileOverlay.classList.remove('open');
    }

    // Mobile event listeners
    if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', toggleMobileMenu);
    }
    if (mobileOverlay) {
        mobileOverlay.addEventListener('click', closeMobileMenu);
    }

    // Mobile theme toggle
    if (themeToggleMobile) {
        themeToggleMobile.addEventListener('click', () => {
            if (themeToggle) themeToggle.click();
        });
    }

    // Close mobile menu when clicking on sidebar links
    const sidebarLinks = sidebar.querySelectorAll('a');
    sidebarLinks.forEach(link => {
        link.addEventListener('click', () => {
            if (window.innerWidth <= 768) {
                closeMobileMenu();
            }
        });
    });

    // Handle window resize
    window.addEventListener('resize', () => {
        if (window.innerWidth > 768) {
            closeMobileMenu();
        }
    });

    // small helpers
    function addMessage(message, sender='bot', opts = {}) {
        const { isHtml=false, extraClasses='' } = opts;
        const container = document.createElement('div');
        const bubbleType = sender === 'user' ? 'chat-bubble-user self-end' : 'chat-bubble-bot self-start';
        container.className = `w-full max-w-md p-3 rounded-xl mb-4 chat-bubble ${bubbleType} ${extraClasses}`;
        if (isHtml) container.innerHTML = message;
        else container.textContent = message;
        chatWindow.appendChild(container);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return container;
    }

    function setInputState(enabled, placeholder = 'Type here...') {
        userInput.disabled = !enabled;
        sendButton.disabled = !enabled;
        userInput.placeholder = placeholder;
        if (enabled) userInput.focus();
    }

    // portfolio health
    async function fetchAndDisplayPortfolioHealth() {
        console.log('fetchAndDisplayPortfolioHealth: Starting...');
        try {
            console.log('fetchAndDisplayPortfolioHealth: Fetching /api/portfolio/health/');
            const r = await fetch('/api/portfolio/health/');
            console.log('fetchAndDisplayPortfolioHealth: Response status:', r.status);
            console.log('fetchAndDisplayPortfolioHealth: Response ok:', r.ok);
            
            if (!r.ok) {
                const errorText = await r.text();
                console.error('fetchAndDisplayPortfolioHealth: Response not ok:', errorText);
                throw new Error(`health fetch failed: ${r.status} ${errorText}`);
            }
            
            const d = await r.json();
            console.log('fetchAndDisplayPortfolioHealth: Response data:', d);
            
            healthScorePlaceholder.classList.add('hidden');
            healthScoreDisplay.classList.remove('hidden');
            
            // Mobile version
            const healthScorePlaceholderMobile = document.getElementById('health-score-placeholder-mobile');
            const healthScoreDisplayMobile = document.getElementById('health-score-display-mobile');
            if (healthScorePlaceholderMobile && healthScoreDisplayMobile) {
                healthScorePlaceholderMobile.classList.add('hidden');
                healthScoreDisplayMobile.classList.remove('hidden');
            }
            
            const getScoreColor = (score) => score >= 7 ? 'text-green-500' : score >= 4 ? 'text-yellow-500' : 'text-red-500';
            const healthHTML = `
                <div class="text-center mb-4">
                    <p class="text-5xl font-bold ${getScoreColor(d.overall_score)}">${d.overall_score}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">out of 10</p>
                </div>
                <div class="space-y-3 text-sm">
                    <div>
                        <div class="flex justify-between items-center mb-1"><p class="font-semibold">Diversification</p><p class="font-bold ${getScoreColor(d.diversification.score)}">${d.diversification.score}/10</p></div>
                        <p class="text-gray-600 dark:text-gray-400">${d.diversification.feedback}</p>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1"><p class="font-semibold">Risk Level</p><p class="font-bold ${getScoreColor(d.risk.score)}">${d.risk.score}/10</p></div>
                        <p class="text-gray-600 dark:text-gray-400">${d.risk.feedback}</p>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1"><p class="font-semibold">Performance</p><p class="font-bold ${getScoreColor(d.performance.score)}">${d.performance.score}/10</p></div>
                        <p class="text-gray-600 dark:text-gray-400">${d.performance.feedback}</p>
                    </div>
                </div>
            `;
            
            healthScoreDisplay.innerHTML = healthHTML;
            if (healthScoreDisplayMobile) {
                healthScoreDisplayMobile.innerHTML = healthHTML;
            }
            console.log('fetchAndDisplayPortfolioHealth: Successfully displayed health data');
        } catch (e) {
            console.error('fetchAndDisplayPortfolioHealth: Error:', e);
            healthScorePlaceholder.textContent = 'Could not load score.';
            const healthScorePlaceholderMobile = document.getElementById('health-score-placeholder-mobile');
            if (healthScorePlaceholderMobile) {
                healthScorePlaceholderMobile.textContent = 'Could not load score.';
            }
        }
    }

    // theme toggle
    if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
        if (lightIcon) lightIcon.classList.remove('hidden');
    } else {
        if (darkIcon) darkIcon.classList.remove('hidden');
    }
    themeToggle && themeToggle.addEventListener('click', () => {
        darkIcon && darkIcon.classList.toggle('hidden');
        lightIcon && lightIcon.classList.toggle('hidden');
        document.documentElement.classList.toggle('dark');
        localStorage.setItem('color-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    });

    // profile dropdown
    profileButton && profileButton.addEventListener('click', () => {
        profileDropdown.classList.toggle('hidden');
        setTimeout(() => profileDropdown.classList.toggle('opacity-0'), 10);
    });
    window.addEventListener('click', (e) => {
        if (profileButton && profileDropdown && !profileButton.contains(e.target) && !profileDropdown.contains(e.target)) {
            profileDropdown.classList.add('hidden', 'opacity-0');
        }
    });

    // Start / greeting flow
    function getGreeting() {
        const hour = new Date().getHours();
        const namePart = userName ? `, ${userName}` : '';
        if (hour < 12) return `Good morning${namePart}!`;
        if (hour < 18) return `Good afternoon${namePart}!`;
        return `Good evening${namePart}!`;
    }

    function startConversation(isInitial=true) {
        if (isInitial) {
            isFirstInteraction = true;
            fetchAndDisplayPortfolioHealth();
            // Load market snapshot at startup
            loadMarketSnapshot();
        }
        // disclaimer below first greeting
        if (initialGreetingEl && isFirstInteraction) {
            const disclaimer = `<p class="text-xs text-gray-900 dark:text-gray-300"><strong>Disclaimer:</strong> This is not financial advice. All investment decisions are your responsibility.</p>`;
            addMessage(disclaimer, 'bot', { isHtml: true, extraClasses: 'bg-yellow-100 dark:bg-yellow-900/20 border border-yellow-300 dark:border-yellow-700' });
            isFirstInteraction = false;
        } else {
            const followUpMessages = [
                "What would you like to explore next? I'm here to help with any investment questions you might have.",
                "Ready for your next financial analysis! What catches your interest - stocks, mutual funds, or portfolio review?",
                "What's next on your investment journey? I can help you analyze any stock or fund you're curious about.",
                "How else can I assist you today? Feel free to ask about any company or investment you're considering.",
                "What financial insights are you looking for? I'm ready to dive deep into any analysis you need.",
                "Ready to analyze another stock or fund? Just tell me what you're interested in!",
                "What's your next investment question? I love helping investors make informed decisions.",
                "What would you like to research next? I can help with detailed analysis of any investment opportunity."
            ];
            const randomMessage = followUpMessages[Math.floor(Math.random() * followUpMessages.length)];
            addMessage(randomMessage, 'bot');
        }
        conversationState = 'AWAITING_PROMPT';
        setInputState(true, 'Type commands like - Analyze a stock or a mutual fund, or Show my portfolio');
        suggestionsBox.innerHTML = '';
    }

    // show cancel
    function showCancelButton() {
        suggestionsBox.innerHTML = `<div id="cancel-container" class="mt-2"><button id="cancel-btn" class="text-sm text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 font-semibold py-1 px-3">Cancel</button></div>`;
        const cancelBtn = document.getElementById('cancel-btn');
        if (cancelBtn) cancelBtn.addEventListener('click', () => {
            addMessage('Action cancelled.', 'bot');
            startConversation(false);
        });
    }

    // ----- NLU call (fixed JSON body + CSRF) -----
    async function callNLU(text) {
        try {
            const headers = { 'Content-Type': 'application/json' };
            if (csrfToken) headers['X-CSRFToken'] = csrfToken;
            const res = await fetch('/api/parse/', {
                method: 'POST',
                headers,
                body: JSON.stringify({ text })
            });
            if (!res.ok) {
                const t = await res.text();
                console.error('NLU error', res.status, t);
                throw new Error('NLU request failed');
            }
            return await res.json();
        } catch (err) {
            console.error(err);
            throw err;
        }
    }

    // ----- Stock flow -----
    async function findAndConfirmStock(entity) {
        const thinking = addMessage(`Searching for "${entity}" on NSE & BSE...`, 'bot');
        try {
            const [nseR, bseR] = await Promise.all([
                fetch(`/api/search/NSE/${encodeURIComponent(entity)}/`),
                fetch(`/api/search/BSE/${encodeURIComponent(entity)}/`)
            ]);
            const nse = await nseR.json();
            const bse = await bseR.json();
            thinking.remove();

            const all = [
                ...((nse.stocks || []).map(s => ({ ...s, exchange: 'NSE' }))),
                ...((bse.stocks || []).map(s => ({ ...s, exchange: 'BSE' })))
            ];
            if (all.length === 0) {
                addMessage(`No stocks found for "${entity}". Try another name.`, 'bot');
                startConversation(false);
                return;
            }
            // Deduplicate similar company names (LTD vs Limited, etc.)
            const deduplicated = [];
            const seenNames = new Set();
            
            all.forEach(s => {
                // Normalize company name for comparison
                const normalizedName = s.name
                    .replace(/\b(LTD|LIMITED)\b/gi, '')
                    .replace(/\b(INC|INCORPORATED)\b/gi, '')
                    .replace(/\b(CORP|CORPORATION)\b/gi, '')
                    .replace(/[.,\s]+/g, ' ')
                    .trim()
                    .toLowerCase();
                
                if (!seenNames.has(normalizedName)) {
                    seenNames.add(normalizedName);
                    deduplicated.push(s);
                }
            });
            
            let html = `<p class="mb-2">I found these — which one did you mean?</p><div id="stock-options" class="space-y-2">`;
            deduplicated.slice(0,4).forEach(s => {
                html += `<button class="choice-btn" data-symbol="${s.symbol}" data-name="${s.name}">${s.name} (${s.symbol}) — ${s.exchange}</button>`;
            });
            html += `</div>`;
            const msg = addMessage(html, 'bot', { isHtml: true });
            msg.querySelectorAll('.choice-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectStock({ symbol: btn.dataset.symbol, name: btn.dataset.name });
                });
            });
            showCancelButton();
        } catch (err) {
            thinking.remove();
            addMessage('Error searching stocks. Try again later.', 'bot');
            startConversation(false);
        }
    }

    function selectStock(stock) {
        addMessage(stock.name, 'user');
        suggestionsBox.innerHTML = '';
        conversationState = 'AWAITING_PRICE';
        analysisContext = { type: 'stock', ticker: stock.symbol, displayName: stock.name };
        addMessage(`Great — what is your average buy price for ${stock.name}?`, 'bot');
        setInputState(true, 'Enter buy price (₹)...');
        showCancelButton();
    }

    // ----- Mutual fund flow -----
    async function findAndConfirmMutualFund(query) {
        const thinking = addMessage(`Searching mutual funds for "${query}"...`, 'bot');
        try {
            const r = await fetch(`/api/search/MF/${encodeURIComponent(query)}/`);
            const data = await r.json();
            thinking.remove();
            const results = (data.funds || []).map(s => ({ name: s.fund_name, scheme_id: s.scheme_id }));
            if (!results.length) {
                addMessage(`No mutual funds found for "${query}". Try another name.`, 'bot');
                startConversation(false);
                return;
            }
            let html = `<p class="mb-2">Which mutual fund did you mean?</p><div id="mf-options" class="space-y-2">`;
            results.slice(0,8).forEach(mf => {
                // Simplify fund names for better user experience
                let displayName = mf.name;
                
                // Remove technical suffixes and make names more user-friendly
                displayName = displayName
                    .replace(/ - Growth Option - Direct Plan/g, ' Direct Growth')
                    .replace(/ - Growth Option/g, ' Growth')
                    .replace(/ - IDCW Option - Direct Plan/g, ' Direct IDCW')
                    .replace(/ - IDCW Option/g, ' IDCW')
                    .replace(/ - Direct Plan/g, ' Direct')
                    .replace(/ - Growth Plan/g, ' Growth')
                    .replace(/ - IDCW Plan/g, ' IDCW')
                    .replace(/DIRECT PLAN -Growth/g, 'Direct Growth')
                    .replace(/DIRECT PLAN - Income Distribution cum Capital Withdrawal Option \(IDCW\)/g, 'Direct IDCW');
                
                // Show scheme code in smaller text
                html += `<button class="choice-btn w-full text-left p-3 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-scheme="${mf.scheme_id}" data-name="${mf.name}">
                    <div class="font-medium">${displayName}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Scheme Code: ${mf.scheme_id}</div>
                </button>`;
            });
            html += `</div>`;
            const msg = addMessage(html, 'bot', { isHtml: true });
            msg.querySelectorAll('.choice-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectMutualFund({ scheme_id: btn.dataset.scheme, name: btn.dataset.name });
                });
            });
            showCancelButton();
        } catch (err) {
            thinking.remove();
            addMessage('Error searching mutual funds. Please try again.', 'bot');
            startConversation(false);
        }
    }

    function selectMutualFund(mf) {
        addMessage(mf.name, 'user');
        suggestionsBox.innerHTML = '';
        conversationState = 'AWAITING_NAV';
        analysisContext = { type: 'mf', scheme_id: mf.scheme_id, displayName: mf.name };
        addMessage(`What's your buy NAV per unit for ${mf.name}? If unknown, enter 0 and I'll use current NAV.`, 'bot');
        setInputState(true, 'Enter buy NAV (or 0)...');
        showCancelButton();
    }

    // ----- Analysis step manager (stock & mf) -----
    async function handleAnalysisStep(message) {
        if (conversationState === 'AWAITING_PRICE') {
            const p = parseFloat(message);
            if (isNaN(p) || p <= 0) {
                addMessage('Please enter a valid positive price.', 'bot');
                setInputState(true, 'Enter buy price (₹)...');
                return;
            }
            analysisContext.buyPrice = p;
            conversationState = 'AWAITING_SHARES';
            addMessage(`How many shares of ${analysisContext.displayName} do you hold? (Enter 0 if none)`, 'bot');
            setInputState(true, 'Enter number of shares...');
        } else if (conversationState === 'AWAITING_SHARES') {
            const s = parseInt(message);
            if (isNaN(s) || s < 0) {
                addMessage('Enter a valid whole number of shares.', 'bot');
                setInputState(true, 'Enter number of shares...');
                return;
            }
            analysisContext.numShares = s;
            await analyzeAndDisplayStock(analysisContext.ticker, analysisContext.buyPrice, s);
            conversationState = 'AWAITING_PROMPT';
        } else if (conversationState === 'AWAITING_NAV') {
            const nav = parseFloat(message);
            if (isNaN(nav) || nav < 0) {
                addMessage('Please enter a valid NAV (number).', 'bot');
                setInputState(true, 'Enter buy NAV (or 0)...');
                return;
            }
            analysisContext.buyNAV = nav;
            conversationState = 'AWAITING_UNITS';
            addMessage(`How many units of ${analysisContext.displayName} do you hold? (Enter 0 if none)`, 'bot');
            setInputState(true, 'Enter number of units...');
        } else if (conversationState === 'AWAITING_UNITS') {
            const units = parseFloat(message);
            if (isNaN(units) || units < 0) {
                addMessage('Enter valid units (can be fractional).', 'bot');
                setInputState(true, 'Enter number of units...');
                return;
            }
            analysisContext.units = units;
            await analyzeAndDisplayMF(analysisContext.scheme_id, analysisContext.buyNAV, units);
            conversationState = 'AWAITING_PROMPT';
        }
    }

    // ----- Analysis calls -----
    async function analyzeAndDisplayStock(ticker, buyPrice, shares) {
        setInputState(false, 'Analyzing stock...');
        suggestionsBox.innerHTML = '';
        const thinking = addMessage(`<div class=\"typing\"><span class=\"dot\"></span><span class=\"dot\"></span><span class=\"dot\"></span></div>`, 'bot', { isHtml: true });
        try {
            const r = await fetch(`/api/analyze/${encodeURIComponent(ticker)}/${encodeURIComponent(buyPrice)}/${encodeURIComponent(shares)}/`);
            const data = await r.json();
            thinking.remove();
            
            // Re-enable input immediately after getting analysis data
            setInputState(true, 'Type commands like - Analyze a stock or mutual fund, or Show my portfolio');
            
            if (r.ok) {
                // Build chart container and details
                const chartId = `chart_${Date.now()}`;
                const html = `<h3 class="font-bold text-lg mb-2">Analysis for ${data.ticker || ticker}</h3>
                    <p class="mb-1"><strong>Your Position:</strong> ${data.num_shares ?? shares} shares at ₹${(data.your_buy_price ?? buyPrice)}</p>
                    <p class="mb-2"><strong>Current Price:</strong> ₹${(data.current_market_price ?? 'N/A')}</p>
                    <hr class="my-2"/>
                    <p class="mb-1"><strong class="text-blue-700 dark:text-blue-400">Actionable Advice:</strong> <span class="font-bold">${data.personalized_advice}</span></p>
                        <p class="text-sm mb-1">${data.reasoning}</p>
                        ${data.strategy_description ? `<p class="text-xs text-gray-600 dark:text-gray-400 mb-3">${data.strategy_description}</p>` : ''}
                    ${Array.isArray(data.fundamentals_notes) && data.fundamentals_notes.length ? `<div class="mb-2 text-xs text-gray-600 dark:text-gray-400"><strong>Fundamentals quick take:</strong> ${data.fundamentals_notes.join(' • ')}</div>` : ''}
                    <div class="mb-3">
                        <button id="add-to-portfolio" class="px-3 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white text-sm">Add to my portfolio</button>
                        <button id="show-fundamentals" class="ml-2 px-3 py-2 rounded-md bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100 text-sm">Show fundamentals</button>
                        <span id="add-result" class="text-sm ml-2"></span>
                    </div>
                    <div class="chart-container bg-white dark:bg-gray-900 p-3 rounded-lg border border-gray-200 dark:border-gray-700 relative" style="height:200px;">
                        <div id="${chartId}_loader" class="absolute inset-0 flex items-center justify-center text-xs text-gray-500">
                            <svg class="animate-spin h-4 w-4 mr-2 text-blue-500" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
                            Loading chart...
                        </div>
                        <canvas id="${chartId}"></canvas>
                    </div>`;
                const msg = addMessage(html, 'bot', { isHtml: true });

                // Bind add-to-portfolio
                const addBtn = msg.querySelector('#add-to-portfolio');
                const addRes = msg.querySelector('#add-result');
                addBtn && addBtn.addEventListener('click', async ()=>{
                    try{
                        const res = await fetch('/api/portfolio/', { 
                            method:'POST', 
                            headers:{ 
                                'Content-Type':'application/json',
                                'X-CSRFToken': csrfToken || ''
                            }, 
                            body: JSON.stringify({ 
                                ticker: ticker, 
                                quantity: shares, 
                                buy_price: buyPrice 
                            }) 
                        });
                        const j = await res.json();
                        if(res.ok){ 
                            addRes.textContent = 'Added!'; 
                            addRes.className = 'text-green-600'; 
                            
                            // Refresh portfolio health automatically
                            setTimeout(() => {
                                fetchAndDisplayPortfolioHealth();
                            }, 1000);
                        } else { 
                            addRes.textContent = j.error || 'Failed to add'; 
                            addRes.className = 'text-red-600'; 
                        }
                    }catch(e){ 
                        console.error('Add to portfolio error:', e);
                        addRes.textContent = 'Failed to add'; 
                        addRes.className = 'text-red-600'; 
                    }
                });

                // Bind fundamentals modal/inline
                const fundBtn = msg.querySelector('#show-fundamentals');
                fundBtn && fundBtn.addEventListener('click', () => {
                    const f = data.fundamentals || {};
                    const notes = Array.isArray(data.fundamentals_notes) ? data.fundamentals_notes : [];
                    const box = document.createElement('div');
                    box.className = 'mt-2 p-3 rounded-md border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900';
                    box.innerHTML = `
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div><span class="font-semibold">Market Cap:</span> ${f.market_cap ?? 'N/A'}</div>
                            <div><span class="font-semibold">ROE:</span> ${f.roe != null ? f.roe.toFixed(2)+'%' : 'N/A'}</div>
                            <div><span class="font-semibold">P/E (TTM):</span> ${f.pe_ttm ?? 'N/A'}</div>
                            <div><span class="font-semibold">EPS (TTM):</span> ${f.eps_ttm ?? 'N/A'}</div>
                            <div><span class="font-semibold">P/B:</span> ${f.pb ?? 'N/A'}</div>
                            <div><span class="font-semibold">Dividend Yield:</span> ${f.dividend_yield != null ? f.dividend_yield.toFixed(2)+'%' : 'N/A'}</div>
                            <div><span class="font-semibold">Book Value:</span> ${f.book_value ?? 'N/A'}</div>
                            <div><span class="font-semibold">Face Value:</span> ${f.face_value ?? 'N/A'}</div>
                        </div>
                        ${notes.length ? `<div class="mt-2 text-gray-600 dark:text-gray-400">${notes.join(' • ')}</div>` : ''}
                    `;
                    fundBtn.replaceWith(box);
                });

                // Fast chart loading with immediate mock data + real data fetch
                const ctx = msg.querySelector(`#${chartId}`).getContext('2d');
                
                // Generate immediate mock data for fast loading
                const generateMockData = (period = '1Y', currentPrice = data.current_market_price || 100) => {
                    const days = period === '1D' ? 1 : period === '7D' ? 7 : period === '1M' ? 30 : period === '6M' ? 180 : 365;
                    const dataPoints = Math.min(days, 100); // Limit data points for performance
                    const series = [];
                    const labels = [];
                    
                    // Start from a lower price and work up to current price
                    const startPrice = currentPrice * 0.7; // Start 30% lower
                    const priceRange = currentPrice - startPrice;
                    
                    for (let i = 0; i < dataPoints; i++) {
                        // Generate realistic price movement ending at current price
                        const progress = i / (dataPoints - 1); // 0 to 1
                        const volatility = 0.01; // 1% daily volatility
                        const random = (Math.random() - 0.5) * volatility;
                        
                        // Linear progression with some randomness, ending at current price
                        let price = startPrice + (priceRange * progress);
                        if (i === dataPoints - 1) {
                            // Last point (today) should be exactly current price
                            price = currentPrice;
                        } else {
                            price = price * (1 + random);
                        }
                        
                        series.push(Math.max(price * 0.5, price)); // Ensure positive prices
                        
                        // Generate date labels
                        const date = new Date();
                        date.setDate(date.getDate() - (dataPoints - 1 - i));
                        labels.push(date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' }));
                    }
                    return { series, labels };
                };
                
                // Create chart immediately with mock data
                const mockData = generateMockData('1Y', data.current_market_price);
                let chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: mockData.labels,
                        datasets: [{
                            label: 'Price (₹)',
                            data: mockData.series,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59,130,246,0.15)',
                            fill: true,
                            tension: 0.25,
                            pointRadius: 2,
                            pointHoverRadius: 4,
                            borderWidth: 2
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false }
                        }, 
                        scales: { 
                            x: { 
                                display: true,
                                grid: { color: 'rgba(156, 163, 175, 0.1)' },
                                ticks: { color: '#6b7280', maxTicksLimit: 6 }
                            }, 
                            y: { 
                                display: true,
                                grid: { color: 'rgba(156, 163, 175, 0.1)' },
                                ticks: { 
                                    color: '#6b7280',
                                    callback: function(value) { return '₹' + value.toFixed(0); }
                                }
                            } 
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
                
                // Remove loader immediately
                const loader = msg.querySelector(`#${chartId}_loader`);
                if (loader) loader.remove();
                
                // Add period toggles with fast mock data switching
                const controls = document.createElement('div');
                controls.className = 'flex items-center space-x-2 mt-2';
                const periods = ['1D','7D','1M','6M','1Y'];
                periods.forEach(p => {
                    const b = document.createElement('button');
                    b.className = 'px-2 py-1 text-xs rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700';
                    b.textContent = p;
                    b.addEventListener('click', async ()=>{
                        // Immediate mock data update for fast response
                        const mockData = generateMockData(p, data.current_market_price);
                        chart.data.labels = mockData.labels;
                        chart.data.datasets[0].data = mockData.series;
                        chart.update();
                        
                        // Try to fetch real data in background (non-blocking)
                        try{
                            const r = await fetch(`/api/history/${encodeURIComponent(ticker)}/?period=${encodeURIComponent(p.toLowerCase())}`);
                            const d2 = await r.json();
                            const s2 = Array.isArray(d2.history)? d2.history: [];
                            if (s2.length > 0) {
                                const lbl2 = [];
                                const now2 = new Date();
                                for (let i = s2.length - 1; i >= 0; i--) {
                                    const date = new Date(now2.getTime() - (s2.length - 1 - i) * 24 * 60 * 60 * 1000);
                                    lbl2.push(date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' }));
                                }
                                chart.data.labels = lbl2;
                                chart.data.datasets[0].data = s2;
                                chart.update();
                            }
                        }catch(e){ 
                            // Keep mock data if real data fails
                            console.warn('Real data fetch failed, keeping mock data', e);
                        }
                    });
                    controls.appendChild(b);
                });
                msg.appendChild(controls);
                
                // Try to fetch real data in background and update if available
                setTimeout(async () => {
                    try {
                        const hr = await fetch(`/api/history/${encodeURIComponent(ticker)}/?period=1y`);
                        const hdata = await hr.json();
                        const series = Array.isArray(hdata.history) ? hdata.history : [];
                        
                        if (series.length > 0) {
                            const labels = [];
                            const now = new Date();
                            for (let i = series.length - 1; i >= 0; i--) {
                                const date = new Date(now.getTime() - (series.length - 1 - i) * 24 * 60 * 60 * 1000);
                                labels.push(date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' }));
                            }
                            chart.data.labels = labels;
                            chart.data.datasets[0].data = series;
                            chart.update();
                        }
                    } catch (e) {
                        console.warn('Background real data fetch failed, keeping mock data', e);
                    }
                }, 500); // Small delay to let mock data show first
            } else {
                addMessage(data.error || 'Error analyzing stock.', 'bot');
            }
        } catch (err) {
            thinking.remove();
            console.error(err);
            addMessage('Error analyzing stock. Try again later.', 'bot');
            // Re-enable input on error
            setInputState(true, 'Type commands like - Analyze a stock or mutual fund, or Show my portfolio');
        }
    }

    // ----- Market snapshot -----
    let snapshotTimer = null;
    async function loadMarketSnapshot(){
        try{
            const r = await fetch('/api/market/snapshot/');
            const d = await r.json();
            const arr = Array.isArray(d.indices) ? d.indices : [];
            const marketStatusData = d.market_status || {};
            
            // Update market status display with backend data
            if (marketStatusData.message) {
                const statusColor = marketStatusData.status === 'open' ? 'text-green-600' : 
                                  marketStatusData.status === 'closed' ? 'text-red-600' : 'text-gray-600';
                marketStatus.innerHTML = `<span class="${statusColor}">${marketStatusData.message}</span>`;
            } else {
                // Fallback to frontend calculation
                const now = new Date();
                const day = now.getUTCDay();
                const istMinutes = now.getUTCHours()*60 + now.getUTCMinutes() + 330; // UTC+5:30
                const istHour = Math.floor(istMinutes/60) % 24;
                const istMin = istMinutes % 60;
                const mins = istHour*60 + istMin;
                const open = 9*60 + 15, close = 15*60 + 30;
                const isWeekday = day >= 1 && day <= 5;
                const live = isWeekday && mins >= open && mins <= close;
                marketStatus.textContent = live ? 'LIVE' : 'Last close';
            }
            
            marketCards.innerHTML = '';
            if (marketCardsMobile) marketCardsMobile.innerHTML = '';
            
            if(arr.length === 0){
                // Show loading state with animated skeleton cards
                marketCards.innerHTML = '';
                for(let i = 0; i < 4; i++) {
                    const loadingCard = document.createElement('div');
                    loadingCard.className = 'market-skeleton-card animate-pulse';
                    loadingCard.innerHTML = `
                        <div class="market-skeleton-content">
                            <div class="market-skeleton-line short bg-gray-300 dark:bg-gray-600"></div>
                            <div class="market-skeleton-line long bg-gray-300 dark:bg-gray-600"></div>
                        </div>
                    `;
                    marketCards.appendChild(loadingCard);
                }
                
                // Show loading message
                const loadingMessage = document.createElement('div');
                loadingMessage.className = 'text-center text-gray-500 dark:text-gray-400 text-sm mt-2';
                loadingMessage.innerHTML = '🔄 Loading market data...';
                marketCards.appendChild(loadingMessage);
                
                // Retry loading after 5 seconds
                setTimeout(() => {
                    loadMarketSnapshot();
                }, 5000);
            } else {
                arr.forEach(x => {
                    const up = (x.change || 0) >= 0;
                    const color = up ? 'text-emerald-600' : 'text-red-600';
                    const bgSoft = up ? 'bg-emerald-50 dark:bg-emerald-900/20' : 'bg-red-50 dark:bg-red-900/20';
                    
                    // Desktop card
                    const card = document.createElement('div');
                    card.className = `min-w-[180px] rounded-md border border-gray-200 dark:border-gray-700 px-2 py-1.5 ${bgSoft} fade-in`;
                    card.innerHTML = `
                        <div class="flex items-baseline justify-between">
                            <span class="text-[12px] font-semibold text-gray-700 dark:text-gray-200">${x.name}</span>
                            <span class="text-[11px] ${color}">${(x.change >= 0 ? '+' : '') + (x.change || 0)} (${(x.change_percent >= 0 ? '+' : '') + (x.change_percent || 0)}%)</span>
                        </div>
                        <div class="text-[13px] font-semibold text-gray-800 dark:text-gray-100">${x.price || x.value || 'N/A'}</div>
                    `;
                    marketCards.appendChild(card);
                    
                    // Mobile card
                    if (marketCardsMobile) {
                        const mobileCard = document.createElement('div');
                        mobileCard.className = `market-card-mobile ${bgSoft} fade-in`;
                        mobileCard.innerHTML = `
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-semibold text-gray-700 dark:text-gray-200">${x.name}</div>
                                    <div class="text-lg font-bold text-gray-800 dark:text-gray-100">${x.price || x.value || 'N/A'}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm ${color}">${(x.change >= 0 ? '+' : '') + (x.change || 0)}</div>
                                    <div class="text-xs ${color}">${(x.change_percent >= 0 ? '+' : '') + (x.change_percent || 0)}%</div>
                                </div>
                            </div>
                        `;
                        marketCardsMobile.appendChild(mobileCard);
                    }
                });
            }
        }catch(e){
            // Show error state with loading animation
            marketCards.innerHTML = '';
            if (marketCardsMobile) marketCardsMobile.innerHTML = '';
            
            // Show loading cards with retry
            for(let i = 0; i < 4; i++) {
                const errorCard = document.createElement('div');
                errorCard.className = 'market-skeleton-card animate-pulse';
                errorCard.innerHTML = `
                    <div class="market-skeleton-content">
                        <div class="market-skeleton-line short bg-gray-300 dark:bg-gray-600"></div>
                        <div class="market-skeleton-line long bg-gray-300 dark:bg-gray-600"></div>
                    </div>
                `;
                marketCards.appendChild(errorCard);
                
                // Mobile error card
                if (marketCardsMobile) {
                    const mobileErrorCard = document.createElement('div');
                    mobileErrorCard.className = 'market-card-mobile animate-pulse';
                    mobileErrorCard.innerHTML = `
                        <div class="text-center text-gray-500 dark:text-gray-400">
                            <div class="text-sm">🔄 Loading...</div>
                        </div>
                    `;
                    marketCardsMobile.appendChild(mobileErrorCard);
                }
            }
            
            // Show retry message
            const retryMessage = document.createElement('div');
            retryMessage.className = 'text-center text-gray-500 dark:text-gray-400 text-sm mt-2';
            retryMessage.innerHTML = '⚠️ Market data unavailable. Retrying...';
            marketCards.appendChild(retryMessage);
            
            // Retry after 3 seconds
            setTimeout(() => {
                loadMarketSnapshot();
            }, 3000);
        }
    }

    function startSnapshotTimer(){
        stopSnapshotTimer();
        snapshotTimer = setInterval(() => { if (!document.hidden) loadMarketSnapshot(); }, 60000);
    }
    function stopSnapshotTimer(){ if (snapshotTimer) { clearInterval(snapshotTimer); snapshotTimer = null; } }
    document.addEventListener('visibilitychange', () => { if (!document.hidden) { loadMarketSnapshot(); startSnapshotTimer(); } });
    setTimeout(startSnapshotTimer, 2000);

    async function analyzeAndDisplayMF(scheme_id, buyNAV, units) {
        setInputState(false, 'Analyzing mutual fund...');
        suggestionsBox.innerHTML = '';
        const thinking = addMessage(`<div class=\"typing\"><span class=\"dot\"></span><span class=\"dot\"></span><span class=\"dot\"></span></div>`, 'bot', { isHtml: true });
        try {
            const r = await fetch(`/api/analyze_mf/${encodeURIComponent(scheme_id)}/${encodeURIComponent(buyNAV)}/${encodeURIComponent(units)}/`);
            console.log('Raw response:', r);
            console.log('Response status:', r.status);
            console.log('Response ok:', r.ok);
            
            const data = await r.json();
            console.log('Parsed data:', data);
            thinking.remove();
            
            console.log('MF Analysis Response:', { status: r.status, ok: r.ok, data });
            
            // Re-enable input immediately after getting analysis data
            setInputState(true, 'Type commands like - Analyze a stock or mutual fund, or Show my portfolio');
            
            if (r.ok && !data.error) {
                console.log('Rendering MF analysis with data:', data);
                
                // Generate unique chart ID
                const chartId = `mf_chart_${Date.now()}`;
                
                const html = `<h3 class="font-bold text-lg mb-2">Analysis for ${data.scheme_name || scheme_id}</h3>
                    <p class="mb-1"><strong>Your Position:</strong> ${data.num_units || units} units at ₹${data.your_buy_nav || buyNAV}</p>
                    <p class="mb-2"><strong>Current NAV:</strong> ₹${data.current_nav || 'N/A'}</p>
                    <hr class="my-2"/>
                    <p class="mb-1"><strong class="text-blue-700 dark:text-blue-400">Actionable Advice:</strong> <span class="font-bold">${data.personalized_advice || 'No advice available'}</span></p>
                    <p class="text-sm mb-1">${data.reasoning || 'No reasoning provided'}</p>
                    ${data.strategy_description ? `<p class="text-xs text-gray-600 dark:text-gray-400 mb-3">${data.strategy_description}</p>` : ''}
                    ${data.pnl_total !== undefined ? `<p class="mb-2"><strong>P&L:</strong> ₹${data.pnl_total}</p>` : ''}
                    <div class="mt-4">
                        <canvas id="mf_${chartId}" width="400" height="200"></canvas>
                        <div id="mf_${chartId}_loader" class="flex items-center justify-center h-48 bg-gray-100 dark:bg-gray-800 rounded">
                            <div class="text-gray-500">Loading chart...</div>
                        </div>
                    </div>
                    <div class="mt-3 flex items-center space-x-2">
                        <button class="action-btn px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700" onclick="addToPortfolio('${scheme_id}', '${data.scheme_name || scheme_id}', '${data.current_nav}', '${units}')">Add to Portfolio</button>
                        <span id="add-result-${scheme_id}" class="text-sm"></span>
                    </div>`;
                console.log('Generated HTML:', html);
                const msg = addMessage(html, 'bot', { isHtml: true });
                
                // Handle add to portfolio functionality
                window.addToPortfolio = async (schemeId, fundName, currentNav, units) => {
                    const addRes = document.getElementById(`add-result-${schemeId}`);
                    addRes.textContent = 'Adding...';
                    addRes.className = 'text-blue-600';
                    try {
                        const res = await fetch('/api/portfolio/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ticker: schemeId,
                                quantity: parseFloat(units) || 0,
                                buy_price: currentNav
                            })
                        });
                        const j = await res.json();
                        if(res.ok){ 
                            addRes.textContent = 'Added!'; 
                            addRes.className = 'text-green-600'; 
                            
                            // Refresh portfolio health automatically
                            setTimeout(() => {
                                fetchAndDisplayPortfolioHealth();
                            }, 1000);
                        }
                        else { addRes.textContent = j.error || 'Failed to add'; addRes.className = 'text-red-600'; }
                    }catch(e){ addRes.textContent = 'Failed to add'; addRes.className = 'text-red-600'; }
                };
                // Fast MF chart loading with immediate mock data + real data fetch
                const c = msg.querySelector(`#mf_${chartId}`).getContext('2d');
                
                // Generate immediate mock NAV data for fast loading
                const generateMockNAVData = (period = '1Y', currentNAV = data.current_nav || 100) => {
                    const days = period === '1D' ? 1 : period === '7D' ? 7 : period === '1M' ? 30 : period === '6M' ? 180 : 365;
                    const dataPoints = Math.min(days, 100); // Limit data points for performance
                    const series = [];
                    const labels = [];
                    
                    // Start from a lower NAV and work up to current NAV
                    const startNAV = currentNAV * 0.8; // Start 20% lower (less volatile than stocks)
                    const navRange = currentNAV - startNAV;
                    
                    for (let i = 0; i < dataPoints; i++) {
                        // Generate realistic NAV movement ending at current NAV
                        const progress = i / (dataPoints - 1); // 0 to 1
                        const volatility = 0.005; // 0.5% daily volatility (lower than stocks)
                        const random = (Math.random() - 0.5) * volatility;
                        
                        // Linear progression with some randomness, ending at current NAV
                        let nav = startNAV + (navRange * progress);
                        if (i === dataPoints - 1) {
                            // Last point (today) should be exactly current NAV
                            nav = currentNAV;
                        } else {
                            nav = nav * (1 + random);
                        }
                        
                        series.push(Math.max(nav * 0.7, nav)); // Ensure positive NAV
                        
                        // Generate date labels
                        const date = new Date();
                        date.setDate(date.getDate() - (dataPoints - 1 - i));
                        labels.push(date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' }));
                    }
                    return { series, labels };
                };
                
                // Create MF chart immediately with mock data
                const mockNAVData = generateMockNAVData('1Y', data.current_nav);
                let mfChart = new Chart(c, { 
                    type:'line', 
                    data:{ 
                        labels: mockNAVData.labels, 
                        datasets:[{ 
                            label:'NAV (₹)', 
                            data: mockNAVData.series, 
                            borderColor:'#10b981', 
                            backgroundColor:'rgba(16,185,129,0.15)', 
                            fill:true, 
                            tension:0.25, 
                            pointRadius:2, 
                            pointHoverRadius:4, 
                            borderWidth:2 
                        }]
                    }, 
                    options:{ 
                        responsive:true, 
                        maintainAspectRatio:false, 
                        plugins:{ 
                            legend:{ display:false } 
                        }, 
                        scales:{ 
                            x:{ 
                                grid:{ color:'rgba(156,163,175,0.1)' }, 
                                ticks:{ color:'#6b7280', maxTicksLimit:6 } 
                            }, 
                            y:{ 
                                grid:{ color:'rgba(156,163,175,0.1)' }, 
                                ticks:{ color:'#6b7280', callback:(v)=>'₹'+Number(v).toFixed(0) } 
                            } 
                        }, 
                        interaction:{ intersect:false, mode:'index' } 
                    } 
                });
                
                // Remove loader immediately
                const ldr = msg.querySelector(`#mf_${chartId}_loader`);
                if (ldr) ldr.remove();

                // Add period toggles with fast mock data switching
                const controls = document.createElement('div');
                controls.className = 'flex items-center space-x-2 mt-2';
                ['1D','7D','1M','6M','1Y'].forEach(p => {
                    const b = document.createElement('button');
                    b.className = 'px-2 py-1 text-xs rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700';
                    b.textContent = p;
                    b.addEventListener('click', async ()=>{
                        // Immediate mock data update for fast response
                        const mockNAVData = generateMockNAVData(p, data.current_nav);
                        mfChart.data.labels = mockNAVData.labels;
                        mfChart.data.datasets[0].data = mockNAVData.series;
                        mfChart.update();
                        
                        // Try to fetch real data in background (non-blocking)
                        try{
                            const r2 = await fetch(`/api/history_mf/${encodeURIComponent(scheme_id)}/?period=${encodeURIComponent(p.toLowerCase())}`);
                            const d2 = await r2.json();
                            const s2 = Array.isArray(d2.history) ? d2.history : [];
                            if (s2.length > 0) {
                                const lbl2 = [];
                                const now2 = new Date();
                                for (let i = s2.length - 1; i >= 0; i--) {
                                    const date = new Date(now2.getTime() - (s2.length - 1 - i) * 24 * 60 * 60 * 1000);
                                    lbl2.push(date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' }));
                                }
                                mfChart.data.labels = lbl2;
                                mfChart.data.datasets[0].data = s2;
                                mfChart.update();
                            }
                        }catch(e){ 
                            // Keep mock data if real data fails
                            console.warn('Real MF data fetch failed, keeping mock data', e);
                        }
                    });
                    controls.appendChild(b);
                });
                msg.appendChild(controls);
                
                // Try to fetch real MF data in background and update if available
                setTimeout(async () => {
                    try {
                        const r2 = await fetch(`/api/history_mf/${encodeURIComponent(scheme_id)}/?period=1y`);
                        const init = await r2.json();
                        const series = Array.isArray(init.history) ? init.history : [];
                        
                        if (series.length > 0) {
                            const labels = [];
                            const now = new Date();
                            for (let i = series.length - 1; i >= 0; i--) {
                                const date = new Date(now.getTime() - (series.length - 1 - i) * 24 * 60 * 60 * 1000);
                                labels.push(date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' }));
                            }
                            mfChart.data.labels = labels;
                            mfChart.data.datasets[0].data = series;
                            mfChart.update();
                        }
                    } catch(e) { 
                        console.warn('Background real MF data fetch failed, keeping mock data', e);
                    }
                }, 500); // Small delay to let mock data show first

            } else {
                // Handle specific error cases
                if (data.error === 'FUND_NOT_FOUND') {
                    addMessage(`Fund not found: ${data.reasoning}`, 'bot');
                    addMessage('Try searching with a different name or check the exact fund name. You can also try searching by scheme code.', 'bot');
                } else {
                    addMessage(data.error || 'Error analyzing mutual fund.', 'bot');
                }
            }
        } catch (err) {
            thinking.remove();
            console.error('MF Analysis Error:', err);
            console.error('Error details:', {
                message: err.message,
                stack: err.stack,
                name: err.name
            });
            addMessage('Error analyzing mutual fund. Try again later.', 'bot');
            // Re-enable input on error
            setInputState(true, 'Type commands like - Analyze a stock or mutual fund, or Show my portfolio');
        }
    }

    // ----- Top-level input handler -----
    async function handleUserInput() {
        const text = userInput.value.trim();
        if (!text) return;
        addMessage(text, 'user');
        userInput.value = '';
        setInputState(false, 'Thinking...');
        suggestionsBox.innerHTML = '';

        // If we're mid-analysis (expecting buy price, shares, etc.)
        if (conversationState === 'AWAITING_PRICE' || conversationState === 'AWAITING_SHARES' || conversationState === 'AWAITING_NAV' || conversationState === 'AWAITING_UNITS') {
            setTimeout(() => handleAnalysisStep(text), 200); // small delay to show user bubble
            return;
        }

        // If a specific flow was requested, bypass NLU
        if (lastRequestedFlow === 'mf') {
            conversationState = 'SEARCHING_MF';
            await findAndConfirmMutualFund(text);
            lastRequestedFlow = null;
            return;
        } else if (lastRequestedFlow === 'stock') {
            conversationState = 'SEARCHING_STOCK';
            await findAndConfirmStock(text);
            lastRequestedFlow = null;
            return;
        }

        // Send to NLU (fixed JSON body)
        try {
            const nlu = await callNLU(text);
            // nlu should contain { intent: 'analyze_stock'|'analyze_mutual_fund'|'view_portfolio'|... , entity: '...' }
            if (!nlu.intent) {
                addMessage("I couldn't extract intent. Try: 'analyze a stock' or 'analyze a mutual fund'.", 'bot');
                startConversation(false);
                return;
            }

            if (nlu.intent === 'analyze_stock') {
                addMessage(`Looking up stock "${nlu.entity || text}"...`, 'bot');
                conversationState = 'SEARCHING_STOCK';
                await findAndConfirmStock(nlu.entity || text);
            } else if (nlu.intent === 'analyze_mutual_fund') {
                addMessage(`Searching mutual funds for "${nlu.entity || text}"...`, 'bot');
                conversationState = 'SEARCHING_MF';
                await findAndConfirmMutualFund(nlu.entity || text);
            } else if (nlu.intent === 'view_portfolio') {
                window.location.href = "{% url 'portfolio' %}";
            } else if (nlu.intent === 'greeting') {
                addMessage(getGreeting(), 'bot');
                setTimeout(() => {
                    const followUpGreetings = [
                        "I'm SAHA-AI, your personal financial analyst! I'm here to help you make smarter investment decisions. What brings you here today?",
                        "Welcome! I'm excited to help you with your investment journey. Whether you want to analyze stocks, research mutual funds, or review your portfolio - I've got you covered!",
                        "Great to see you! I'm your financial assistant, ready to help you navigate the markets. What would you like to explore first?",
                        "Hello there! I'm here to make investing easier for you. I can analyze stocks, help with mutual fund research, or review your portfolio. What interests you most?"
                    ];
                    const randomGreeting = followUpGreetings[Math.floor(Math.random() * followUpGreetings.length)];
                    addMessage(randomGreeting, 'bot');
                }, 1000);
            } else if (nlu.intent === 'how_are_you') {
                const responses = [
                    "I'm doing really well, thanks for asking! I've been analyzing market trends and helping investors make informed decisions. How about you - how's your investment journey going?",
                    "I'm great! Just been keeping up with the latest market movements and financial news. It's been quite an interesting day in the markets. How are you feeling about your portfolio?",
                    "I'm doing fantastic! I love helping people navigate the complex world of investing. What brings you here today - looking to analyze some stocks or maybe review your portfolio?",
                    "I'm excellent, thank you! I've been busy analyzing various stocks and mutual funds for investors like yourself. How can I help you with your financial goals today?"
                ];
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                addMessage(randomResponse, 'bot');
            } else if (nlu.intent === 'help') {
                const responses = [
                    "I'd be happy to help! I'm your personal financial analyst, and I can assist you with several things:",
                    "Of course! I'm here to make your investment decisions easier. Here's what I can do for you:",
                    "I'd love to help! As your financial assistant, I can provide insights on:",
                    "Absolutely! I'm designed to help you navigate the world of investing. I can help with:"
                ];
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                addMessage(randomResponse, 'bot');
                setTimeout(() => {
                    addMessage('• **Stock Analysis** - I can analyze any stock you\'re interested in, showing you charts, fundamentals, and personalized investment advice based on your portfolio', 'bot');
                }, 800);
                setTimeout(() => {
                    addMessage('• **Mutual Fund Research** - I can help you research mutual funds, track NAV performance, and understand fund characteristics', 'bot');
                }, 1600);
                setTimeout(() => {
                    addMessage('• **Portfolio Management** - I can review your current holdings, calculate portfolio health scores, and suggest improvements', 'bot');
                }, 2400);
                setTimeout(() => {
                    addMessage('Just tell me what you\'d like to explore - for example, "analyze Apple stock" or "show me my portfolio health". What interests you most?', 'bot');
                }, 3200);
            } else if (nlu.intent === 'thanks') {
                const responses = [
                    "You're very welcome! I'm always here when you need financial insights or have investment questions.",
                    "My pleasure! Helping you make informed investment decisions is what I love doing.",
                    "You're welcome! Feel free to come back anytime you need help with stocks, funds, or portfolio analysis.",
                    "Happy to help! That's what I'm here for - making your investment journey smoother and more informed."
                ];
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                addMessage(randomResponse, 'bot');
            } else if (nlu.intent === 'cancel_action') {
                addMessage('Cancelled.', 'bot');
                startConversation(false);
            } else {
                const responses = [
                    "I'm not quite sure what you're looking for, but I'd love to help! I can assist you with:",
                    "Hmm, I didn't catch that, but no worries! Let me tell you what I can help you with:",
                    "I'm not entirely sure what you meant, but I'm here to help! I can provide insights on:",
                    "Could you clarify that for me? In the meantime, here's what I can help you with:"
                ];
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                addMessage(randomResponse, 'bot');
                setTimeout(() => {
                    addMessage("📈 **Stock Analysis** - Analyze Indian stocks like 'Reliance', 'TCS', 'HDFC Bank', or 'Infosys'", 'bot');
                }, 800);
                setTimeout(() => {
                    addMessage("🏦 **Mutual Fund Research** - Find and analyze Indian mutual funds and SIPs", 'bot');
                }, 1600);
                setTimeout(() => {
                    addMessage("📊 **Portfolio Review** - Check your portfolio health and get personalized suggestions", 'bot');
                }, 2400);
                setTimeout(() => {
                    addMessage("💡 **Market Insights** - Get real-time NSE/BSE data and market trends", 'bot');
                }, 3200);
                setTimeout(() => {
                    addMessage("Try: 'analyze Reliance stock', 'show my portfolio', or 'market data'. What would you like to explore? 🚀", 'bot');
                }, 4000);
            }
        } catch (err) {
            console.error(err);
            addMessage('Error connecting to language service. Please try again.', 'bot');
            startConversation(false);
        }
    }

    // ----- Quick chip bindings -----
    chipAnalyzeStock && chipAnalyzeStock.addEventListener('click', () => {
        addMessage('Analyze a stock', 'user');
        addMessage('Sure — type the stock name or symbol you want me to analyze (e.g., "reliance").', 'bot');
        setInputState(true, 'Type stock name or symbol...');
        lastRequestedFlow = 'stock';
    });
    chipAnalyzeMF && chipAnalyzeMF.addEventListener('click', () => {
        addMessage('Analyze a mutual fund', 'user');
        addMessage('Sure — type the mutual fund name or scheme id (e.g., "HDFC Top 100").', 'bot');
        setInputState(true, 'Type mutual fund name or scheme id...');
        lastRequestedFlow = 'mf';
    });
    chipShowPortfolio && chipShowPortfolio.addEventListener('click', () => {
        addMessage('Show my portfolio', 'user');
        window.location.href = "{% url 'portfolio' %}";
    });

    // keypress & send button
    sendButton.addEventListener('click', handleUserInput);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleUserInput();
    });

    // Ensure initial greeting exists (if not, create)
    if (!document.getElementById('initial-greeting')) {
        const greetingDiv = document.createElement('div');
        greetingDiv.id = 'initial-greeting';
        greetingDiv.className = "w-full max-w-md p-3 rounded-xl mb-4 chat-bubble chat-bubble-bot";
        greetingDiv.textContent = "Hi, I am SAHA-AI, How may I help you today?";
        chatWindow.prepend(greetingDiv);
    }

    // kick off
    startConversation(true);
});
</script>
</body>
</html>
